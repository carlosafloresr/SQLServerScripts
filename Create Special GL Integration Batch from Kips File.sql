DECLARE	@Integration	varchar(6) = 'SPCGL', 
		@JustDisplay	bit = 0,
        @Company		varchar(5) = DB_NAME(),
        @BatchId		varchar(15),
		@DatePortion	Varchar(15) = GPCustom.dbo.PADL(MONTH(GETDATE()), 2, '0') + GPCustom.dbo.PADL(DAY(GETDATE()), 2, '0') + RIGHT(GPCustom.dbo.PADL(YEAR(GETDATE()), 4, '0'), 2) + GPCustom.dbo.PADL(DATEPART(HOUR, GETDATE()), 2, '0') + GPCustom.dbo.PADL(DATEPART(MINUTE, GETDATE()), 2, '0'),
		@PstgDate		date,
		@Refrence		varchar(30),
		@TrxDate		date = '12/05/2020',
		@Series			smallint,
		@UserId			varchar(15),
		@ActNumSt		varchar(75),
		@CrdtAmnt		numeric(18,2),
		@DebitAmt		numeric(18,2),
		@Dscriptn		varchar(30),
		@SqncLine		int

DECLARE	@AccountCrd		Varchar(15) = '0-99-1866',
		@AccountCrd2	Varchar(15) = '1-00-4199',
		@AccountDeb		Varchar(15) = '1-00-5199'

SET @BatchId = 'REVERSAL2_12-05' --@Integration + @DatePortion
			 -- XXXXXXXXXXXXXXX

SELECT	TRXDATE,
		REFRENCE,
		SERIES,
		ACTNUMST,
		CRDTAMNT,
		DEBITAMT
INTO	#tmpData
FROM	(
		SELECT	*
		FROM	(
				SELECT	RTRIM(GL2.REFRENCE) AS REFRENCE,
						ISNULL(@TrxDate,GL2.TRXDATE) AS TRXDATE,
						RTRIM(GL5.ACTNUMST) AS ACTNUMST,
						GL2.DEBITAMT * 1 AS DEBITAMT,
						GL2.CRDTAMNT * 1 AS CRDTAMNT,
						CASE WHEN GL2.SOURCDOC = 'PMTRX' THEN 'AP' ELSE 'GL' END AS RECTYPE,
						GL2.ORMSTRID AS VENDORID,
						GL2.ORDOCNUM AS DOCUMENTID,
						GL2.ORPSTDDT AS POSTINGDATE,
						GL2.SERIES
				FROM	GL20000 GL2
						INNER JOIN GL00105 GL5 ON GL2.ACTINDX = GL5.ACTINDX
				WHERE	JRNENTRY IN (628719,
628720,
628728,
628729,
617282,
617289,
617301,
628730,
628731,
628732,
628733,
628734,
628735,
628736,
617382,
628737,
628738,
628739,
628740,
628741,
617465,
628742,
617494,
628743,
628746,
617507,
617585,
617603,
628779,
625925,
617709,
625931,
617719,
617739,
625954,
625956,
625958,
625965,
625967,
625969,
625972,
628794,
628805,
628809,
628818,
628819,
628820,
628821,
628822,
628823,
628824,
628825,
628826,
628827,
628828,
628829,
628830,
628831,
628832,
628833,
628834,
628835,
617782,
617789,
625987,
617792,
617796,
625997,
617799,
617810,
617814,
617827,
628836,
628837,
628838,
628839,
628840,
628841,
628842,
628843,
628844,
628845,
628846,
628847,
628848,
617856,
628849,
628850,
628851,
628852,
628853,
628854,
628855,
628856,
628857,
628858,
628860,
628861,
628862,
628863,
628864,
628865,
628866,
628867,
628868,
628869,
628870,
628871,
628872,
628873,
628874,
628875,
628876,
628877,
628878,
617924,
617926,
617929,
617932,
617939,
617941,
628879,
628880,
617966,
628881,
628882,
628883,
617996,
628884,
628885,
628886,
628887,
628888,
628889,
628890,
628891,
628892,
628893,
628894,
628895,
628896,
618022,
618036,
618045,
618056,
618063,
628897,
628898,
628899,
628901,
628902,
628903,
628904,
628905,
628906,
628907,
628908,
628909,
628910,
628911,
628912,
628913,
628914,
628915,
628916,
628917,
628918,
628919,
628920,
628921,
628922,
628923,
628924,
628925,
628926,
628927,
628928,
628929,
628930,
628931,
628932,
628933,
628934,
628936,
628937,
628938,
628939,
628940,
628941,
628942,
628943,
628944,
628945,
628946,
628947,
628948,
628949,
628950,
628951,
628952,
628953,
628954,
628955,
628956,
628957,
628958,
628959,
628960,
628961,
628962,
628963,
628964,
628965,
628966,
628967,
628968,
628969,
628970,
628971,
628972,
628976,
626058,
628995,
628998,
618121,
618143,
629004,
629012,
629031,
629033,
629044,
629046,
629049,
629053,
629055,
629062,
629064,
629067,
629072,
629074,
629078,
629082,
629084,
629089,
629094,
629116,
629122,
629124,
629131,
629133,
629145,
629151,
629155,
629158,
629161,
629163,
629167,
629170,
629179,
629185,
629191,
629207,
629212,
626085,
618160,
618194,
618199,
618208,
629224,
629233,
629240,
629242,
629250,
629252,
629256,
629277,
626130,
626149,
626158,
629309,
629318,
629326,
629330,
629334,
629339,
629348,
629353,
629355,
629357,
629361,
629370,
629382,
629387,
631367,
629421,
629423,
629439,
626196,
626207,
626210,
626211,
626227,
626231,
626241,
629458,
629461,
629464,
629479,
629482,
629501,
626251,
629537,
629539,
629545,
629547,
629549,
629554,
629556,
629558)
				) DATA
WHERE	RECTYPE = 'GL'
		) G1

DECLARE curData CURSOR LOCAL KEYSET OPTIMISTIC FOR
SELECT	@Integration AS Integration,
		@Company AS Company,
		@BatchId AS BatchId,
		TRXDATE,
		REFRENCE,
		TRXDATE,
		2 AS SERIES,
		'CFLORES' AS UserId,
		ACTNUMST,
		DEBITAMT,
		CRDTAMNT,
		REFRENCE AS TRXDESCRIP,
		0 as RowNumber --ROW_NUMBER() OVER(PARTITION BY Invoice ORDER BY Invoice) * 500 AS RowNumber
FROM	#tmpData
ORDER BY REFRENCE, ACTNUMST

IF @JustDisplay = 0
BEGIN
	IF (SELECT [Name] FROM sys.servers WHERE Server_Id = 0) = 'PRISQL01P'
	BEGIN
		DELETE	IntegrationsDB.Integrations.dbo.Integrations_GL
		WHERE	Company = @Company
				AND BatchId = @BatchId
				AND Integration = @Integration

		DELETE	IntegrationsDB.Integrations.dbo.ReceivedIntegrations
		WHERE	Company = @Company
				AND BatchId = @BatchId
				AND Integration = @Integration
	END
	ELSE
	BEGIN
		DELETE	PRISQL004P.Integrations.dbo.Integrations_GL
		WHERE	Company = @Company
				AND BatchId = @BatchId
				AND Integration = @Integration

		DELETE	PRISQL004P.Integrations.dbo.ReceivedIntegrations
		WHERE	Company = @Company
				AND BatchId = @BatchId
				AND Integration = @Integration
	END

	OPEN curData 
	FETCH FROM curData INTO @Integration, @Company, @BatchId, @PstgDate, @Refrence, @TrxDate, @Series,
										  @UserId, @ActNumSt, @CrdtAmnt, @DebitAmt, @Dscriptn, @SqncLine

	WHILE @@FETCH_STATUS = 0 
	BEGIN
		IF (SELECT [Name] FROM sys.servers WHERE Server_Id = 0) = 'PRISQL01P'
			EXECUTE IntegrationsDB.Integrations.dbo.USP_Integrations_GL @Integration, @Company, @BatchId, @PstgDate, @Refrence, @TrxDate, @Series,
												  @UserId, @ActNumSt, @CrdtAmnt, @DebitAmt, @Dscriptn, Null, Null, Null, Null, Null, Null, Null, @SqncLine
		ELSE
			EXECUTE PRISQL004P.Integrations.dbo.USP_Integrations_GL @Integration, @Company, @BatchId, @PstgDate, @Refrence, @TrxDate, @Series,
												  @UserId, @ActNumSt, @CrdtAmnt, @DebitAmt, @Dscriptn, Null, Null, Null, Null, Null, Null, Null, @SqncLine

		FETCH FROM curData INTO @Integration, @Company, @BatchId, @PstgDate, @Refrence, @TrxDate, @Series,
											  @UserId, @ActNumSt, @CrdtAmnt, @DebitAmt, @Dscriptn, @SqncLine
	END

	CLOSE curData
	DEALLOCATE curData

	IF @@ERROR = 0
	BEGIN
		IF (SELECT [Name] FROM sys.servers WHERE Server_Id = 0) = 'PRISQL01P'
		BEGIN
			EXECUTE IntegrationsDB.Integrations.dbo.USP_ReceivedIntegrations @Integration, @Company, @BatchId
			EXECUTE IntegrationsDB.Integrations.dbo.USP_Integrations_GL_Select @Company, @BatchId, @Integration
		END
		ELSE
		BEGIN
			EXECUTE PRISQL004P.Integrations.dbo.USP_ReceivedIntegrations @Integration, @Company, @BatchId
			EXECUTE PRISQL004P.Integrations.dbo.USP_Integrations_GL_Select @Company, @BatchId, @Integration
		END
	END
END
ELSE
	SELECT * FROM #tmpData ORDER BY REFRENCE, ACTNUMST

DROP TABLE #tmpData

GO