SELECT 	OpenYear,
		JrnEntry AS Journal,
		CASE WHEN Voided = 1 THEN 'YES' ELSE 'NO' END AS Voided,
		ORGNTSRC,
		Refrence,
		TrxDate AS TransactionDate,
		UswhPstd AS PostingUser,
		OrmstrId AS VendorId,
		Ormstrnm AS VendorName,
		Orpstddt AS PostingDate,
		GL20000.ACTINDX,
		RTRIM(ACTNUMBR_1) + '-' + RTRIM(ACTNUMBR_2) + '-' + RTRIM(ACTNUMBR_3) AS Account,
		ActDescr,
		ORCTRNUM AS VchrNmbr,
		OrigSeqNum,
		GL20000.CrdtAmnt,
		GL20000.DebitAmt,
		ER.*
FROM	GL20000
		LEFT JOIN GL00100 ON GL20000.ACTINDX = GL00100.ACTINDX
		LEFT JOIN PM30600 ON GL20000.ORCTRNUM = PM30600.VchrNmbr AND GL20000.ORGNTSRC = PM30600.TRXSORCE AND GL20000.ACTINDX = PM30600.DSTINDX AND GL20000.ORIGSEQNUM = PM30600.DSTSQNUM
		LEFT JOIN PM10100 ON GL20000.ORCTRNUM = PM10100.VchrNmbr AND GL20000.ORGNTSRC = PM10100.TRXSORCE AND GL20000.ACTINDX = PM10100.DSTINDX AND GL20000.ORIGSEQNUM = PM10100.DSTSQNUM
		LEFT JOIN GPCUSTOM.dbo.ExpenseRecoverables ER ON GL20000.ORGNTSRC = ER.TRXSource AND RTRIM(ACTNUMBR_1) + '-' + RTRIM(ACTNUMBR_2) + '-' + RTRIM(ACTNUMBR_3) = ER.GLAccount and ER.TRXSource IS NOT NULL AND CASE WHEN GL20000.CrdtAmnt = 0 THEN GL20000.DebitAmt ELSE GL20000.CrdtAmnt END = ABS(Amount)
WHERE	LEFT(ORGNTSRC, 5) = 'PMTRX' AND
		ORCTRNUM IN (SELECT ORCTRNUM
FROM	GL20000
		LEFT JOIN GL00100 ON GL20000.ACTINDX = GL00100.ACTINDX
		LEFT JOIN PM30600 ON GL20000.ORCTRNUM = PM30600.VchrNmbr AND GL20000.ORGNTSRC = PM30600.TRXSORCE AND GL20000.ACTINDX = PM30600.DSTINDX AND GL20000.ORIGSEQNUM = PM30600.DSTSQNUM
		LEFT JOIN PM10100 ON GL20000.ORCTRNUM = PM10100.VchrNmbr AND GL20000.ORGNTSRC = PM10100.TRXSORCE AND GL20000.ACTINDX = PM10100.DSTINDX AND GL20000.ORIGSEQNUM = PM10100.DSTSQNUM
WHERE	LEFT(ORGNTSRC, 5) = 'PMTRX' AND 
		ISNULL(PM30600.VchrNmbr, PM10100.VchrNmbr) IS NULL AND
		RTRIM(ACTNUMBR_1) + '-' + RTRIM(ACTNUMBR_2) + '-' + RTRIM(ACTNUMBR_3) IN ('0-00-1102', '0-00-1103', '0-00-1104', '0-00-1105'))
ORDER BY
		GL20000.ORGNTSRC,
		ORCTRNUM, RTRIM(ACTNUMBR_1) + '-' + RTRIM(ACTNUMBR_2) + '-' + RTRIM(ACTNUMBR_3)

/*
SELECT * FROM GPCUSTOM.dbo.ExpenseRecoverables order by iNVOICENo
SELECT * FROM GL20000 WHERE JrnEntry = 3851
SELECT * FROM PM30600 WHERE VchrNmbr + TRXSORCE IN (SELECT ORCTRNUM + ORTRXSRC FROM GL20000 WHERE JrnEntry = 3851)
select * from GL10001 where jrnentry = 14567
select * from DTA00301
*/