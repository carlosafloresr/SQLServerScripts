DECLARE @tblData	Table (
		Journal		Int,
		GLAccount	Varchar(15),
		Reference	Varchar(50),
		ProNumber	Varchar(12) Null,
		Debit		Numeric(10,2),
		Credit		Numeric(10,2),
		DataSource	Varchar(30),
		TblSource	Varchar(10))

INSERT INTO @tblData
SELECT	GL2.JRNENTRY, 
		RTRIM(GL5.ACTNUMST) AS ACCOUNT, 
		RTRIM(GL2.REFRENCE) AS REFRENCE,
		GPCustom.dbo.FindProNumber(GL2.REFRENCE) AS ProNumber,
		GL2.DEBITAMT, 
		GL2.CRDTAMNT, 
		GL2.ORGNTSRC,
		'OPEN' AS TBLSOURCE
FROM	GL20000 GL2
		INNER JOIN GL00105 GL5 ON GL2.ACTINDX = GL5.ACTINDX
WHERE	GL5.ACTNUMST = '0-99-1866'
		AND GL2.REFRENCE IN ('95-146464|CMAU8100654',
'ICB:D97-107527|70-100020',
'96-110605|FDCU0441428',
'96-110159|YMLU8482617',
'95-169015|BMOU4343714',
'ICB|96-114746|57-115490',
'ICB|96-114746|57-115490',
'ICB|96-114746|57-115490',
'ICB|96-114746|57-115490',
'96-113079|TCLU855627-3',
'96-113079|TCLU855627-3',
'ICB|97-111586|55-150891',
'ICB|55-150891|97-111586',
'ICB|96-116381|57-117164',
'ICB|96-116961|57-118005',
'ICB|96-117071|57-118341',
'ICB|57-117209|96-116296',
'ICB|95-179267|11-138060        ',
'95-179267|11-138060',
'ICB|95-179268|11-138061        ',
'95-179268|11-138061',
'ICB|95-179271|11-138064        ',
'95-179271|11-138064',
'ICB|95-179272|11-138065        ',
'95-179272|11-138065',
'ICB|95-179649|11-138129        ',
'95-179649|11-138129',
'ICB|95-179650|11-138130        ',
'95-179650|11-138130',
'ICB|95-170623|57-117275',
'ICB|96-115742|34-241018',
'ICB|96-116703|34-241557',
'ICB|95-176225|35-150786',
'ICB|95-180202|11-138478',
'95-180202|11-138478',
'ICB|95-180575|15-184463',
'95-180575|15-184463',
'ICB|95-181010|95-107121',
'95-181010|95-107121')
UNION SELECT	GL2.JRNENTRY, 
		RTRIM(GL5.ACTNUMST) AS ACCOUNT, 
		RTRIM(GL2.REFRENCE) AS REFRENCE, 
		GPCustom.dbo.FindProNumber(GL2.REFRENCE) AS ProNumber,
		GL2.DEBITAMT, 
		GL2.CRDTAMNT, 
		GL2.ORGNTSRC,
		'HISTORICAL' AS TBLSOURCE
FROM	GL30000 GL2
		INNER JOIN GL00105 GL5 ON GL2.ACTINDX = GL5.ACTINDX
WHERE	GL5.ACTNUMST = '0-99-1866'
		AND GL2.REFRENCE  IN ('95-146464|CMAU8100654',
'ICB:D97-107527|70-100020',
'96-110605|FDCU0441428',
'96-110159|YMLU8482617',
'95-169015|BMOU4343714',
'ICB|96-114746|57-115490',
'ICB|96-114746|57-115490',
'ICB|96-114746|57-115490',
'ICB|96-114746|57-115490',
'96-113079|TCLU855627-3',
'96-113079|TCLU855627-3',
'ICB|97-111586|55-150891',
'ICB|55-150891|97-111586',
'ICB|96-116381|57-117164',
'ICB|96-116961|57-118005',
'ICB|96-117071|57-118341',
'ICB|57-117209|96-116296',
'ICB|95-179267|11-138060        ',
'95-179267|11-138060',
'ICB|95-179268|11-138061        ',
'95-179268|11-138061',
'ICB|95-179271|11-138064        ',
'95-179271|11-138064',
'ICB|95-179272|11-138065        ',
'95-179272|11-138065',
'ICB|95-179649|11-138129        ',
'95-179649|11-138129',
'ICB|95-179650|11-138130        ',
'95-179650|11-138130',
'ICB|95-170623|57-117275',
'ICB|96-115742|34-241018',
'ICB|96-116703|34-241557',
'ICB|95-176225|35-150786',
'ICB|95-180202|11-138478',
'95-180202|11-138478',
'ICB|95-180575|15-184463',
'95-180575|15-184463',
'ICB|95-181010|95-107121',
'95-181010|95-107121')

DECLARE @tblDataAll	Table (
		Journal		Int,
		GLAccount	Varchar(15),
		Reference	Varchar(50),
		ProNumber	Varchar(12) Null,
		Debit		Numeric(10,2),
		Credit		Numeric(10,2),
		DataSource	Varchar(30),
		TblSource	Varchar(10),
		BatchId		Varchar(20),
		VendorId	Varchar(12),
		Amount		Numeric(10,2),
		PrePayRef	Varchar(50),
		JrnlMatch	Int)

INSERT INTO @tblDataAll
SELECT	DAT.*,
		FSI.BatchId,
		FSI.RecordCode AS VendorId,
		FSI.ChargeAmount1 AS Amount,
		'ICB|' + FSI.PrepayReference AS PrepayReference,
		JRNL_Match = (SELECT TOP 1 GL.JRNENTRY FROM GL20000 GL WHERE GL.ACTINDX IN (613, 650) AND GL.ORGNTSRC NOT LIKE 'ICB%' AND (GL.REFRENCE = ('ICB|' + FSI.PrepayReference) OR GL.REFRENCE = FSI.PrepayReference))
FROM	@tblData DAT
		LEFT JOIN PRISQL004P.Integrations.dbo.View_Integration_FSI_Full FSI ON DAT.ProNumber = FSI.InvoiceNumber AND FSI.ICB_AP = 1 --AND FSI.RecordCode = 'VND'
WHERE	DAT.DataSource LIKE 'ICB%'

SELECT	DAT.*,
		GLD.ACTNUMST
FROM	@tblDataAll DAT
		INNER JOIN (SELECT JRNENTRY, REFRENCE, RTRIM(GL5.ACTNUMST) AS ACTNUMST FROM GL20000 GL2 INNER JOIN GL00105 GL5 ON GL2.ACTINDX = GL5.ACTINDX AND GL5.ACTNUMST LIKE '%1866') GLD ON DAT.JrnlMatch = GLD.JRNENTRY AND PrePayRef = GLD.REFRENCE