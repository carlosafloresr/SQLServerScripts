ALTER VIEW View_Expense_Reporting
AS
SELECT	GL20000.JrnEntry AS Test,
	GL00100.USRDEFS1 AS Category, 
	GL20000.ORGNTSRC,
	CONVERT(DateTime, GL20000.TRXDATE, 101) AS EffDate, 
	CASE WHEN GL20000.ORDOCNUM = '' THEN CAST(GL20000.JRNENTRY AS Char(10)) ELSE GL20000.ORDOCNUM END AS DocNumber, 
	CASE WHEN PM30600.DISTREF = '' THEN GL20000.DSCRIPTN ELSE ISNULL(PM30600.DISTREF, GL20000.DSCRIPTN) END AS Reference, 
	GL00100.ACTNUMBR_1 AS Acct1, 
	GL00100.ACTNUMBR_2 AS Acct2, 
	GL00100.ACTNUMBR_3 AS Acct3, 
	RTRIM(GL00100.ACTNUMBR_1) + '-' + RTRIM(GL00100.ACTNUMBR_2) + '-' + GL00100.ACTNUMBR_3 AS Account,
	GL00100.ACTDESCR AS AcctDescription, 
	GL20000.CRDTAMNT, 
	GL20000.DEBITAMT,
	ISNULL(PM30200.VCHRNMBR, CAST(GL20000.JRNENTRY AS Char(20))) AS VoucherNo,
	ISNULL(RTRIM(CAST(VEND1.VendorId AS Char(10))) + '-' + VEND1.VENDSHNM, 'General Ledger') AS Vendor,
	ISNULL(PM30200.DOCDATE, GL20000.TRXDATE) AS DOCDATE,
	PM30200.VOIDPDATE,
	GL20000.JRNENTRY,
	ISNULL(PM30200.VOIDED, GL20000.VOIDED) AS VOIDED
FROM 	GL20000 
	INNER JOIN GL00100 ON GL20000.ACTINDX = GL00100.ACTINDX
	LEFT JOIN PM30600 ON GL20000.OrcTrnum = PM30600.VchrNmbr AND GL20000.ORGNTSRC = PM30600.TRXSORCE AND GL20000.ORIGSEQNUM = PM30600.DSTSQNUM AND LEFT(GL20000.SOURCDOC, 2) = 'PM'
	LEFT JOIN PM30200 ON PM30600.VchrNmbr = PM30200.VchrNmbr AND PM30600.TRXSORCE = PM30200.TRXSORCE AND PM30200.VOIDED = 0
	LEFT JOIN PM00200 VEND1 ON PM30200.VendorId = VEND1.VendorId
WHERE 	GL20000.Voided = 0 AND
	GL00100.ACTNUMBR_3 > '4999' AND
	((LEFT(GL20000.SOURCDOC, 2) = 'PM' AND PM30600.VchrNmbr IS NOT Null) OR
	(LEFT(GL20000.ORTRXSRC, 5) = 'GLTRX'))
UNION
SELECT	GL20000.JrnEntry AS Test,
	GL00100.USRDEFS1 AS Category, 
	GL20000.ORGNTSRC,
	CONVERT(DateTime, GL20000.TRXDATE, 101) AS EffDate, 
	CASE WHEN GL20000.ORDOCNUM = '' THEN CAST(GL20000.JRNENTRY AS Char(10)) ELSE GL20000.ORDOCNUM END AS DocNumber, 
	CASE WHEN PM10100.DISTREF = '' THEN GL20000.DSCRIPTN ELSE ISNULL(PM10100.DISTREF, GL20000.DSCRIPTN) END AS Reference, 
	GL00100.ACTNUMBR_1 AS Acct1, 
	GL00100.ACTNUMBR_2 AS Acct2, 
	GL00100.ACTNUMBR_3 AS Acct3, 
	RTRIM(GL00100.ACTNUMBR_1) + '-' + RTRIM(GL00100.ACTNUMBR_2) + '-' + GL00100.ACTNUMBR_3 AS Account,
	GL00100.ACTDESCR AS AcctDescription, 
	GL20000.CRDTAMNT, 
	GL20000.DEBITAMT,
	COALESCE(PM20000.VCHRNMBR, PM20000.VCHRNMBR, CAST(GL20000.JRNENTRY AS Char(20))) AS VoucherNo,
	ISNULL(RTRIM(CAST(VEND1.VendorId AS Char(10))) + '-' + VEND1.VENDSHNM, 'General Ledger') AS Vendor,
	ISNULL(PM20000.DOCDATE, GL20000.TRXDATE) AS DOCDATE,
	NULL,
	GL20000.JRNENTRY,
	ISNULL(PM20000.VOIDED, GL20000.VOIDED) AS VOIDED
FROM 	GL20000 
	INNER JOIN GL00100 ON GL20000.ACTINDX = GL00100.ACTINDX
	LEFT JOIN PM10100 ON GL20000.OrcTrnum = PM10100.VchrNmbr AND GL20000.ORGNTSRC = PM10100.TRXSORCE AND GL20000.ORIGSEQNUM = PM10100.DSTSQNUM AND LEFT(GL20000.SOURCDOC, 2) = 'PM'
	LEFT JOIN PM20000 ON PM10100.VchrNmbr = PM20000.VchrNmbr AND PM10100.TRXSORCE = PM20000.TRXSORCE
	LEFT JOIN PM00200 VEND1 ON PM20000.VendorId = VEND1.VendorId
WHERE 	GL20000.Voided = 0 AND
	GL00100.ACTNUMBR_3 > '4999' AND
	((LEFT(GL20000.SOURCDOC, 2) = 'PM' AND PM10100.VchrNmbr IS NOT Null) OR
	(LEFT(GL20000.ORTRXSRC, 5) = 'GLTRX'))

SELECT 	*
FROM   	AIS.dbo.View_Expense_Reporting
WHERE  (Acct2>='00' AND Acct2<='12') AND (EffDate>={ts '2007-09-30 00:00:00'} AND EffDate<{ts '2007-11-04 00:00:00'}) AND (Acct3>='5000' AND Acct3<='9000') AND (Acct1>='0' AND Acct1<='99')
ORDER BY Acct2, Category, Acct3

/*
	SELECT * FROM GL20000 WHERE ACTINDX = 355 AND ORPSTDDT BETWEEN '9/30/2007' AND '11/3/2007'
	SELECT * FROM GL00100 WHERE ACTNUMBR_3 = '6040'
	VoucherNo, 
	Vendor, 
	Reference, 
	DocNumber, 
	DOCDATE, 
	EffDate, 
	Account, 
	AcctDescription, 
	Acct2, 
	Category, 
	CRDTAMNT, 
	DEBITAMT, 
	Acct3,
	Acct1

select * from GL20000
/*