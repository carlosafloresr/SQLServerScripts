DECLARE	@inv_no		Int,
		@status		Varchar(5),
		@labor		Numeric(10,2),
		@parts		Numeric(10,2),
		@inv_est	Char(1),
		@rep_date	Date,
		@Query		Varchar(MAX),
		@Changed	Bit

DECLARE	@TblData Table
(
	Inv_No			Int,
	SQL_InvEst		Char(1),
	SQL_Status		Varchar(10),
	SQL_Labor		Numeric(10,2),
	SQL_Parts		Numeric(10,2),
	SQL_Total		Numeric(10,2),
	FI_InvEst		Char(1),
	FI_Status		Varchar(10),
	FI_Labor		Numeric(10,2),
	FI_Parts		Numeric(10,2),
	FI_Total		Numeric(10,2),
	[Difference]	Numeric(10,2)
)

DECLARE Estimates CURSOR LOCAL KEYSET OPTIMISTIC FOR
SELECT	inv_no,
		status,
		labor,
		parts,
		inv_est,
		rep_date
FROM	View_FI_Estimates
WHERE	historical = 0
		AND INV_NO in (1156109,
1156511,
1156437,
1155506,
1156017,
1156020,
1155257,
1156510,
1156519,
1155252,
1156502,
1156514,
1156432,
1156520,
1155516,
1156433,
1154841,
1155246,
1155345,
1155488,
1155989,
1156501,
1156496,
1154342,
1154537,
1155219,
1155443,
1155889,
1156031,
1156445,
1156481,
1156507,
1155236,
1155454,
1153394,
1154036,
1155433,
1152902,
1152798,
1153286,
1152742,
1154567,
1154590,
1155495,
1156436,
1156472,
1156499,
1152034,
1153888,
1156448,
1154516,
1151886,
1151935,
1152098,
1152375,
1153774,
1153876,
1154359,
1154483,
1155355,
1152209,
1153715,
1150627,
1152084,
1150266,
1152062,
1151686,
1154517,
1156438,
1150015,
1148696,
1149370,
1149506,
1154316,
1148977,
1148983,
1149392,
1149509,
1149525,
1149895,
1151143,
1151150,
1149552,
1148250,
1148253,
1148495,
1148704,
1149306,
1149540,
1148294,
1148710,
1148758,
1149014,
1149303,
1149471,
1149488,
1149873,
1148234,
1148231,
1148246,
1148699,
1149267,
1149385,
1149872,
1148307,
1149494,
1150903,
1148104,
1148423,
1148725,
1148936,
1149377,
1148133,
1148226,
1148272,
1148297,
1148301,
1149299,
1149336,
1149880,
1149902,
1147208,
1148155,
1148883,
1148120,
1147225,
1147965,
1149239,
1147081,
1148188,
1148921,
1148790,
1147056,
1147251,
1148172,
1148744,
1148772,
1149422,
1150885,
1151095,
1149846,
1149848,
1147962,
1148148,
1146774,
1147080,
1147229,
1148095,
1148255,
1148260,
1149758,
1148150,
1146741,
1147292,
1146729,
1147913,
1145984,
1145620,
1145974,
1151122,
1145308,
1145899,
1146009,
1145596,
1144983,
1149835,
1145441,
1145891,
1145932,
1147945,
1149874,
1151384,
1144524,
1144745,
1144708,
1144843,
1145386,
1145392,
1144949,
1144737,
1145411,
1145439,
1145995,
1144520,
1144863,
1145363,
1144503,
1141383,
1141858,
1144646,
1141902,
1142111,
1142787,
1141626,
1142822,
1143017,
1142952,
1140657,
1144705,
1140520,
1141128,
1142223,
1140571,
1140605,
1141586,
1145907,
1141824,
1140324,
1141882,
1140468,
1138737,
1139046,
1139503,
1139538,
1138418,
1139327,
1139381,
1139052,
1141821,
1139551,
1137031,
1139061,
1136301,
1136834,
1137086,
1137105,
1139044)

OPEN Estimates
FETCH FROM Estimates INTO @inv_no, @status, @labor, @parts, @inv_est, @rep_date

WHILE @@FETCH_STATUS = 0 
BEGIN
	SET @Query = N'SELECT INV_NO, ACCT_NO, INV_EST, CONTAINER, CHASSIS, GENSET_NO, INV_DATE, INV_TOTAL, LABOR_HOUR, LABOR, MECH_HOURS, PARTS, CDEX_REMK, WEEK_END, ESTATUS, ENTRY_DATE, REP_DATE, EST_DATE FROM Invoices WHERE Inv_No = ' + CAST(@inv_no AS varchar)

	EXECUTE USP_QueryFIDepot @Query, '##tmpData'

	INSERT INTO @TblData
	SELECT	@inv_no,
			@inv_est,
			@status,
			@labor,
			@parts,
			@labor + @parts,
			Inv_Est,
			Estatus,
			Labor,
			Parts,
			Labor + Parts,
			(@labor + @parts) - (Labor + Parts)
	FROM	##tmpData

	DROP TABLE ##tmpData

	FETCH FROM Estimates INTO @inv_no, @status, @labor, @parts, @inv_est, @rep_date
END

SELECT	*
FROM	@TblData
WHERE	[Difference] <> 0

SELECT	SUM(SQL_Total),
		SUM(FI_Total)
FROM	@TblData

CLOSE Estimates
DEALLOCATE Estimates

