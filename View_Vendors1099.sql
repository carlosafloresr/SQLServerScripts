/*
select * from PM00201 order by vendorid
SELECT * FROM PM00202 WHERE Year1 = 2008 AND HistType = 0 AND VENDORID = '11881' ORDER BY VendorID, PeriodID
SELECT * FROM PM00202 WHERE Year1 = 2008 AND VENDORID = '11070' --AND HistType = 1 ORDER BY VendorID, PeriodID 
SELECT * FROM PM00201 WHERE VendorId = '11070'
SELECT * FROM SY40101
SELECT TOP 25 VENDORID,HIESTBAL,CURRBLNC,NOINVYTD,NOINVLIF,NOINVLYR,NOPINYTD,NOPILIFE,AMBLDTYD,AMBLDLIF,AMBLDLYR,AMTPDYTD,AMTPDLIF,AMTPDLYR,TEN99AYTD,TEN99ALIF,TEN99ALYR,DISAVYTD,DISAVLIF,DISAVLYR,DISTKYTD,DISTKNLF,DISTKLYR,DISLSYTD,DISLSTLF,DISLSLYR,FINCHLIF,FINCHLYR,FINCHYTD,WROFSYTD,WROFSLIF,WROFSLYR,RTRNSYTD,RTRNSLIF,RTRNSLYR,TRDTKLIF,TRDTLYR,TRDTYTD,NFNCHLIF,NFNCHLYR,NFNCHYTD,RTNGOWED,LSTCHNUM,LSTCHKDT,LSTCHAMT,LSTINNUM,LSTINVAM,LSTPURDT,FSTPURDT,CURUNPBN,UNPDFNCH,DYCHTCLR,AVGDTPYR,AVDTPLIF,ACCRDINV,ONORDAMT,WITHYTD,WITHLYR,Withholding_LIFE,DEX_ROW_ID FROM IMC.dbo.PM00201 WITH ( NOLOCK) WHERE VENDORID = '11070' ORDER BY VENDORID ASC 
SELECT '', 0, 0, 0, ISNULL(SUM(AMBLDLIF),0), ISNULL(SUM(AMTPDLIF),0), ISNULL(SUM(TEN99ALIF),0), ISNULL(SUM(DISAVLIF),0), ISNULL(SUM(DISTKNLF),0), ISNULL(SUM(DISLSTLF),0), ISNULL(SUM(FINCHLIF),0), ISNULL(SUM(WROFSLIF),0), ISNULL(SUM(RTRNSLIF),0), ISNULL(SUM(TRDTKLIF),0), ISNULL(SUM(NFNCHLIF),0), ISNULL(SUM(NOINVLIF),0), ISNULL(SUM(Withholding_LIFE),0), 0 FROM PM00202 WHERE HISTTYPE = 1 AND VENDORID = '11070' AND YEAR1 = 2008
SELECT '', 0, 0, 0, ISNULL(SUM(AMBLDLIF),0), ISNULL(SUM(AMTPDLIF),0), ISNULL(SUM(TEN99ALIF),0), ISNULL(SUM(DISAVLIF),0), ISNULL(SUM(DISTKNLF),0), ISNULL(SUM(DISLSTLF),0), ISNULL(SUM(FINCHLIF),0), ISNULL(SUM(WROFSLIF),0), ISNULL(SUM(RTRNSLIF),0), ISNULL(SUM(TRDTKLIF),0), ISNULL(SUM(NFNCHLIF),0), ISNULL(SUM(NOINVLIF),0), ISNULL(SUM(Withholding_LIFE),0), 0 FROM PM00202 WHERE HISTTYPE = 1 AND VENDORID = '11070' AND YEAR1 = 2008 AND PeriodId < 12
PRINT 9810.39000 - 3386.03000
*/
--CREATE VIEW View_Vendors1099
--AS
SELECT 	PM00202.VendorID,
		UPPER(CASE WHEN VndClsId = 'DRV' AND GPCustom.dbo.AT('#', VendName, 1) > 0 THEN LEFT(VendName, GPCustom.dbo.AT('#', VendName, 1) - 1) 
		ELSE (CASE WHEN VndClsId = 'DRV' AND GPCustom.dbo.AT(RTRIM(PM00200.VendorId), VendName, 1) > 0 THEN LEFT(VendName, GPCustom.dbo.AT(' ' + RTRIM(PM00200.VendorID), VendName, 1) - 1) 
		ELSE VendName END) END) AS VendName,
		PM00200.TxIDNmbr,
		PM00200.Address1,
		PM00200.Address2,
		PM00200.City,
		PM00200.State,
		PM00200.ZipCode,
		PM00200.UserDef1,
		SY01500.CmpnyNam AS CompanyName,
		SY01500.TaxRegTn,
		RTRIM(SY01500.Address1) + ' ' + SY01500.Address2 AS CoAddress,
		SY01500.City AS CoCity,
		SY01500.State AS CoState,
		SY01500.ZipCode AS CoZipCode,
		Year1,
		PM00200.Ten99Type,
		SUM(Ten99Alif) AS AmtpDlif
FROM 	PM00202
		INNER JOIN PM00200 ON PM00202.VendorID = PM00200.VendorID
		LEFT JOIN Dynamics.dbo.SY01500 SY01500 ON SY01500.InterId = DB_NAME()
WHERE 	HistType = 0
		AND PM00200.Ten99Type > 1
		AND PM00202.Year1 = '2008'
GROUP BY 
		PM00202.VendorID,
		UPPER(CASE WHEN VndClsId = 'DRV' AND GPCustom.dbo.AT('#', VendName, 1) > 0 THEN LEFT(VendName, GPCustom.dbo.AT('#', VendName, 1) - 1) 
		ELSE (CASE WHEN VndClsId = 'DRV' AND GPCustom.dbo.AT(RTRIM(PM00200.VendorId), VendName, 1) > 0 THEN LEFT(VendName, GPCustom.dbo.AT(' ' + RTRIM(PM00200.VendorID), VendName, 1) - 1) 
		ELSE VendName END) END),
		PM00200.VendName,
		PM00200.TxIDNmbr,
		PM00200.Address1,
		PM00200.Address2,
		PM00200.City,
		PM00200.State,
		PM00200.ZipCode,
		PM00200.UserDef1,
		SY01500.CmpnyNam,
		SY01500.TaxRegTn,
		RTRIM(SY01500.Address1) + ' ' + SY01500.Address2,
		SY01500.City,
		SY01500.State,
		SY01500.ZipCode,
		Year1,
		PM00200.Ten99Type
HAVING	SUM(Ten99Alif) > 599.99
ORDER BY
		PM00200.VendName

/*
SELECT * FROM PM00200 WHERE VENDORID IN (110,172,326)

SELECT * FROM Dynamics.dbo.SY01500

UPDATE	Dynamics.dbo.SY01500
SET		TaxRegTn = '62-1146133'
WHERE	InterId = 'IMC'
*/