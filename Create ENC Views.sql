 create view [dbo].[ENCBPO1] as select CURR.PONUMBER,  ORD,  POLNESTA,   POTYPE,  CNTRLBLKTBY,  LineNumber,  EXTDCOST,   QTYORDER,  QTYCANCE,   UNITCOST,  REMSUBTO,   SUBTOTAL,  BLNKTLINEEXTQTYSUM,  INVINDX,   REQDATE,  UOFM,    UMQTYINB,  DECPLCUR,   DECPLQTY,  ORIGIN=0 from POP10110 as CURR left join(select PONUMBER,  CNTRLBLKTBY,  REMSUBTO,  SUBTOTAL,  BLNKTLINEEXTQTYSUM  from POP10100  ) as HDR1  on HDR1.PONUMBER=CURR.PONUMBER where LineNumber=0 union select HIST.PONUMBER,   ORD,  POLNESTA,    POTYPE,  CNTRLBLKTBY,   LineNumber,  EXTDCOST,    QTYORDER,  QTYCANCE,    UNITCOST,  REMSUBTO,    SUBTOTAL,  BLNKTLINEEXTQTYSUM,  INVINDX,    REQDATE,  UOFM,     UMQTYINB,  DECPLCUR,    DECPLQTY,  ORIGIN=1 from POP30110 as HIST left join(select PONUMBER,  CNTRLBLKTBY,  REMSUBTO,  SUBTOTAL,  BLNKTLINEEXTQTYSUM  from POP30100  ) as HDR1  on HDR1.PONUMBER=HIST.PONUMBER where LineNumber=0    
GO

 create view [dbo].[ENCBPO2] as select POP.PONUMBER,  POP.ORD,  POP.POLNESTA,  POP.POTYPE,  POP.CNTRLBLKTBY,  isnull( (select ENCBSTAT  from ENC10110  where ENC10110.PONUMBER=POP.PONUMBER and  ENC10110.POLNENUM=POP.ORD and  ENC10110.LineNumber=0  ),0) as ENCBSTAT,  POP.QTYORDER,  POP.QTYCANCE,  POP.UNITCOST,  (CASE WHEN (POLNESTA>3) THEN 0.0   ELSE EXTDCOST END) AS PO_AMT,  isnull( (select ENCMBAMT  from ENC10110  where ENC10110.PONUMBER=POP.PONUMBER and  ENC10110.POLNENUM=POP.ORD and  ENC10110.LineNumber=0 and  (ENCBSTAT<3)  ),0) AS PARENT_AMT,  isnull( (select sum(ENCMBAMT)  from ENC10111  where ENC10111.PONUMBER=POP.PONUMBER and  ENC10111.POLNENUM=POP.ORD and  ENC10111.LineNumber=0 and  (ENCBSTAT<3)  ),0) AS PARENTHIST_AMT,  isnull( (select SUM(ENCMBAMT)  from ENC10110  where ENC10110.PONUMBER=POP.PONUMBER and  ENC10110.LineNumber>0 and  (ENCBSTAT<3)  ),0) AS CHILD_AMT,  isnull( (select SUM((QTYORDER-QTYCANCE)*CURR.UNITCOST)  from ENC10111  left join (select PONUMBER, POLNENUM, UNITCOST  from ENC10110  ) as CURR  on CURR.PONUMBER=ENC10111.PONUMBER and CURR.POLNENUM=ENC10111.POLNENUM  where ENC10111.PONUMBER=POP.PONUMBER and  LineNumber>0 and  (ENCBSTAT<3)  ),0) AS CHILDHIST_AMT, (CASE WHEN (POP.POTYPE=1 or POP.POTYPE=3) THEN  isnull(( select sum(RCPT.QTYSHPPD*LINE.UNITCOST)  from ENC10500 AS RCPT  inner join (select  *  from ENC10110) as LINE  on LINE.PONUMBER=RCPT.PONUMBER and LINE.POLNENUM=RCPT.POLNENUM  where LINE.ENCBSTAT<>3 and  LINE.PONUMBER=POP.PONUMBER  ),0) ELSE  isnull(( select SUM(RCPT.QTYINVCD*LINE.UNITCOST)  from ENC10500 AS RCPT  inner join (select  *  from ENC10110) as LINE  on LINE.PONUMBER=RCPT.PONUMBER and LINE.POLNENUM=RCPT.POLNENUM  where LINE.PONUMBER=POP.PONUMBER and  LINE.ENCBSTAT<>3  ),0) END) AS LIQUID_AMT,  round(POP_CHILD_AMT_BY_QTY,5)     AS POP_CHILD_AMT_BY_QTY,  round(POP_CHILD_AMT_BY_VALUE,5)     AS POP_CHILD_AMT_BY_VALUE,  round(ENC_CHILD_AMT_BY_QTY,5)     AS ENC_CHILD_AMT_BY_QTY,  round(ENC_CHILD_AMT_BY_VALUE,5)     AS ENC_CHILD_AMT_BY_VALUE,  round(POP.BLNKTLINEEXTQTYSUM*POP.UNITCOST,5) AS POP_HDR_AMT_BY_QTY,  REMSUBTO AS POP_HDR_AMT_BY_VALUE from ENCBPO1 AS POP left join (select PONUMBER,  ORD,  LineNumber,  UNITCOST,  (QTYCHILD)    AS POP_CHILD_QTY,  (AMT_BY_QTY)  AS POP_CHILD_AMT_BY_QTY,  (AMT_BY_VALUE)  AS POP_CHILD_AMT_BY_VALUE  from ENC00117  ) AS POPCHILDBYQTY  on POPCHILDBYQTY.PONUMBER=POP.PONUMBER and POPCHILDBYQTY.ORD=POP.ORD left join (select PONUMBER,  ORD,  LineNumber,  UNITCOST,  (QTYCHILD)    AS ENC_CHILD_QTY,  (AMT_BY_QTY)  AS ENC_CHILD_AMT_BY_QTY,  (AMT_BY_VALUE)  AS ENC_CHILD_AMT_BY_VALUE  from ENC00118  ) AS ENCCHILDBYQTY  on ENCCHILDBYQTY.PONUMBER=POP.PONUMBER and ENCCHILDBYQTY.ORD=POP.ORD where ORIGIN=0 group by POP.PONUMBER,   POP.ORD,  POP.POLNESTA,    POP.POTYPE,  POP.CNTRLBLKTBY,  POP.QTYORDER,    POP.QTYCANCE,  POP.UNITCOST,    POP.EXTDCOST,  POP_CHILD_AMT_BY_QTY,  POP_CHILD_AMT_BY_VALUE,  ENC_CHILD_AMT_BY_QTY,  ENC_CHILD_AMT_BY_VALUE,  POP.BLNKTLINEEXTQTYSUM,  POP.REMSUBTO    
GO

 create view [dbo].[ENCBPO3] AS select  * from ENCBPO2 where   (PARENT_AMT<>PARENTHIST_AMT) or  (CNTRLBLKTBY=0 and POP_CHILD_AMT_BY_QTY  <>ENC_CHILD_AMT_BY_QTY) or  (CNTRLBLKTBY=1 and POP_CHILD_AMT_BY_VALUE <>ENC_CHILD_AMT_BY_VALUE) or  (ENCBSTAT=4 and CHILD_AMT+LIQUID_AMT<>CHILDHIST_AMT) or  (ENCBSTAT<3 and CHILD_AMT<>CHILDHIST_AMT)    
GO


